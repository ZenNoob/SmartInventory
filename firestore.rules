/**
 * Core Philosophy: This ruleset enforces role-based access control for managing categories, products, customers, sales transactions, and payments. It leverages structural segregation by defining distinct role collections (roles_admin, roles_accountant, roles_inventory_manager) and avoids complex rule chains by using separate collections instead of flags within the documents. All write operations are restricted to users with specific roles.
 * Data Structure: The database consists of top-level collections for each entity: `/categories/{categoryId}`, `/products/{productId}`, `/customers/{customerId}`, `/sales_transactions/{salesTransactionId}`, `/payments/{paymentId}`, and `/users/{userId}`. User role information is stored in dedicated collections `/roles_admin/{userId}`, `/roles_accountant/{userId}`, and `/roles_inventory_manager/{userId}`. Relationships between entities are maintained via ID references.
 * Key Security Decisions: Listing of the main collections (categories, products, customers, sales_transactions, and payments) is denied to prevent unauthorized data exposure. User documents in `/users/{userId}` are only accessible to the owner. Role-based access is enforced for creating, updating, and deleting documents in most collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Determines if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Determines if the user has the specified role.
     * @param {string} role The role to check for (e.g., 'admin', 'accountant', 'inventory_manager').
     * @return {bool} True if the user has the role, false otherwise.
     */
    function hasRole(role) {
        return exists(/databases/$(database)/documents/roles_$(role)/$(request.auth.uid));
    }

    /**
     * @description Determines if the user is an admin.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return hasRole('admin');
    }

    /**
     * @description Determines if the user is an accountant.
     * @return {bool} True if the user is an accountant, false otherwise.
     */
    function isAccountant() {
      return hasRole('accountant');
    }

    /**
     * @description Determines if the user is an inventory manager.
     * @return {bool} True if the user is an inventory manager, false otherwise.
     */
    function isInventoryManager() {
      return hasRole('inventory_manager');
    }

    /**
     * @description Determines if the user owns the document at the specified path.
     * @param {string} userId The user ID to check against.
     * @return {bool} True if the user owns the document, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Determines if the user owns the existing document at the specified path.
     * @param {string} userId The user ID to check against.
     * @return {bool} True if the user owns the document and it exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /categories/{categoryId} collection.
     * @path /categories/{categoryId}
     * @allow (create) User with admin role can create a category.
     * @deny (create) User without admin role cannot create a category.
     * @principle Enforces role-based access control for category creation.
     */
    match /categories/{categoryId} {
      allow get: if true;
      allow list: if false;
      allow create: if isAdmin() || isInventoryManager();
      allow update: if isAdmin() || isInventoryManager();
      allow delete: if isAdmin() || isInventoryManager();
    }

    /**
     * @description Rules for the /products/{productId} collection.
     * @path /products/{productId}
     * @allow (create) User with admin role can create a product.
     * @deny (create) User without admin role cannot create a product.
     * @principle Enforces role-based access control for product creation.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if false;
      allow create: if isAdmin() || isInventoryManager();
      allow update: if isAdmin() || isInventoryManager();
      allow delete: if isAdmin() || isInventoryManager();
    }

    /**
     * @description Rules for the /customers/{customerId} collection.
     * @path /customers/{customerId}
     * @allow (create) User with accountant role can create a customer.
     * @deny (create) User without accountant role cannot create a customer.
     * @principle Enforces role-based access control for customer creation.
     */
    match /customers/{customerId} {
      allow get: if isAdmin() || isAccountant();
      allow list: if false;
      allow create: if isAdmin() || isAccountant();
      allow update: if isAdmin() || isAccountant();
      allow delete: if isAdmin() || isAccountant();
    }

    /**
     * @description Rules for the /sales_transactions/{salesTransactionId} collection.
     * @path /sales_transactions/{salesTransactionId}
     * @allow (create) User with accountant role can create a sales transaction.
     * @deny (create) User without accountant role cannot create a sales transaction.
     * @principle Enforces role-based access control for sales transaction creation.
     */
    match /sales_transactions/{salesTransactionId} {
      allow get: if isAdmin() || isAccountant();
      allow list: if false;
      allow create: if isAdmin() || isAccountant();
      allow update: if isAdmin() || isAccountant();
      allow delete: if isAdmin() || isAccountant();
    }

    /**
     * @description Rules for the /sales_transactions/{salesTransactionId}/sales_items/{salesItemId} collection.
     * @path /sales_transactions/{salesTransactionId}/sales_items/{salesItemId}
     * @allow (create) User with accountant role can create a sales item.
     * @deny (create) User without accountant role cannot create a sales item.
     * @principle Enforces role-based access control for sales item creation.
     */
    match /sales_transactions/{salesTransactionId}/sales_items/{salesItemId} {
      allow get: if isAdmin() || isAccountant();
      allow list: if false;
      allow create: if isAdmin() || isAccountant();
      allow update: if isAdmin() || isAccountant();
      allow delete: if isAdmin() || isAccountant();
    }

    /**
     * @description Rules for the /payments/{paymentId} collection.
     * @path /payments/{paymentId}
     * @allow (create) User with accountant role can create a payment.
     * @deny (create) User without accountant role cannot create a payment.
     * @principle Enforces role-based access control for payment creation.
     */
    match /payments/{paymentId} {
      allow get: if isAdmin() || isAccountant();
      allow list: if false;
      allow create: if isAdmin() || isAccountant();
      allow update: if isAdmin() || isAccountant();
      allow delete: if isAdmin() || isAccountant();
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User can create their own user document.
     * @deny (create) User cannot create a document with a different userId.
     * @principle Enforces ownership for user documents.
     */
    match /users/{userId} {
        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
    }

       /**
     * @description Rules for the /roles_accountant/{userId} collection.
     * @path /roles_accountant/{userId}
     */
    match /roles_accountant/{userId} {
        allow get: if isAdmin() || isAccountant();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /roles_inventory_manager/{userId} collection.
     * @path /roles_inventory_manager/{userId}
     */
    match /roles_inventory_manager/{userId} {
        allow get: if isAdmin() || isInventoryManager();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
    }
  }
}